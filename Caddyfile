# Caddy Configuration for noVNC Multi-VM Routing
# Production-ready, scales to multiple VPS hosts

{
    email venkat@polydev.ai
    # Use staging while testing to avoid rate limits
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

# HTTP redirect (for when you have a domain)
# http://vnc.polydev.ai {
#     redir https://{host}{uri} permanent
# }

# Main proxy - works with IP for now, domain later
:80 {
    # Health check
    @health path /health
    respond @health "Caddy VNC Proxy OK" 200

    # Serve noVNC static files
    @novnc path /novnc/*
    handle @novnc {
        root * /usr/share/novnc
        file_server
    }

    # Dynamic VNC routing
    # URL format: /vnc/192.168.100.X
    # Captures VM IP and proxies WebSocket to that VM's VNC port
    @vnc path_regexp vnc /vnc/(?P<vmip>192\.168\.100\.(?:[2-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-4]))
    handle @vnc {
        # Remove /vnc/IP prefix before proxying
        uri strip_prefix /vnc/{re.vnc.vmip}

        # Reverse proxy to VM's VNC port
        # Caddy automatically handles WebSocket upgrade
        # NOTE: Cannot use {placeholder} with http:// scheme, so omit scheme
        reverse_proxy {re.vnc.vmip}:5901 {
            # Preserve headers
            header_up Host {upstream_hostport}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}

            # Long timeout for VNC sessions
            transport http {
                read_timeout 3600s
                write_timeout 3600s
            }
        }
    }

    # Default response
    respond "VNC Proxy - Use /vnc/VM_IP to connect" 200

    # Logging - use stdout for systemd journal
    log {
        format json
    }
}
