name: Deploy to VPS

on:
  push:
    branches:
      - main
    paths:
      - 'master-controller/**'
      - 'vm-browser-agent/**'
      - 'scripts/**'
      - 'supabase/migrations/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          echo "üöÄ Deploying to VPS..."

          # Install sshpass
          sudo apt-get update -qq
          sudo apt-get install -y sshpass

          # Deploy master-controller
          echo "üì¶ Syncing master-controller..."
          sshpass -p "$VPS_PASSWORD" rsync -avz \
            -e "ssh -o StrictHostKeyChecking=no" \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude 'logs' \
            ./master-controller/ \
            $VPS_USER@$VPS_HOST:/opt/master-controller/

          # Install dependencies on VPS
          echo "üì¶ Installing dependencies..."
          sshpass -p "$VPS_PASSWORD" ssh -o StrictHostKeyChecking=no \
            $VPS_USER@$VPS_HOST "cd /opt/master-controller && npm install --production"

          # Deploy .env file separately (not in git)
          echo "üì¶ Deploying .env configuration..."
          sshpass -p "$VPS_PASSWORD" rsync -avz \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./master-controller/.env \
            $VPS_USER@$VPS_HOST:/opt/master-controller/.env

          # Deploy vm-browser-agent
          echo "üì¶ Syncing vm-browser-agent..."
          sshpass -p "$VPS_PASSWORD" rsync -avz \
            -e "ssh -o StrictHostKeyChecking=no" \
            --exclude 'node_modules' \
            ./vm-browser-agent/ \
            $VPS_USER@$VPS_HOST:/opt/vm-browser-agent/

          # Deploy scripts
          echo "üì¶ Syncing scripts..."
          sshpass -p "$VPS_PASSWORD" ssh -o StrictHostKeyChecking=no \
            $VPS_USER@$VPS_HOST "mkdir -p /opt/scripts"

          sshpass -p "$VPS_PASSWORD" rsync -avz \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./scripts/ \
            $VPS_USER@$VPS_HOST:/opt/scripts/

          # Restart master-controller service
          echo "üîÑ Restarting master-controller..."
          sshpass -p "$VPS_PASSWORD" ssh -o StrictHostKeyChecking=no \
            $VPS_USER@$VPS_HOST "systemctl restart master-controller || pkill -HUP -f 'node.*index.js'"

          echo "‚úÖ Deployment complete!"

          # Health check
          echo "üè• Running health check..."
          sleep 5
          sshpass -p "$VPS_PASSWORD" ssh -o StrictHostKeyChecking=no \
            $VPS_USER@$VPS_HOST "curl -f http://localhost:4000/health || echo 'Health check pending...'"

      - name: Notify deployment status
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
            exit 1
          fi
